<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Editor de Pixeles - Ajuste Fino</title>
  <style>
    :root { 
      --bg-color: #f0f2f5; 
      --text-color: #333; 
      --panel-bg: #ffffff;
      --border-color: #ccc;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #121212; 
        --text-color: #e0e0e0; 
        --panel-bg: #1e1e1e;
        --border-color: #444;
      }
    }

    body { 
      font-family: 'Segoe UI', sans-serif; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      min-height: 100vh; 
      margin: 0; 
      background: var(--bg-color); 
      color: var(--text-color);
      overscroll-behavior: none; 
      transition: background 0.3s ease;
    }
    
    .grid-container { 
      outline: 4px solid #000;
      margin-bottom: 25px; 
      line-height: 0;
      touch-action: none; 
      width: 400px;
      height: 400px;
      background: white;
    }

    #grid { 
      display: grid; 
      grid-template-columns: repeat(16, 25px); 
      grid-template-rows: repeat(16, 25px); 
      width: 400px;
      height: 400px;
    }

    .cell { 
      width: 25px; 
      height: 25px; 
      box-sizing: border-box;
      cursor: crosshair;
      background-color: #ffffff;
      /* AJEDREZ NIVEL MEDIO: 4 cuadros por píxel */
      background-image: 
        linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee), 
        linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee);
      background-size: 25px 25px; /* Tamaño total del patrón */
      background-position: 0 0, 12.5px 12.5px; /* Desfase a la mitad exacta */
      border: 0.1px solid rgba(0,0,0,0.05);
    }

    .palette { display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; max-width: 420px; margin-bottom: 25px; }
    .swatch { width: 38px; height: 38px; border-radius: 6px; cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.1s; }
    .swatch.selected { border-color: #9146ff; transform: scale(1.15); z-index: 10; box-shadow: 0 0 12px rgba(145, 70, 255, 0.6); }
    
    .swatch-transparent {
      background-image: linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%), 
                        linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%);
      background-size: 10px 10px;
      background-position: 0 0, 5px 5px;
      background-color: white;
    }

    .controls { display: flex; gap: 15px; margin-bottom: 25px; }
    button { padding: 12px 28px; font-size: 16px; cursor: pointer; border: none; border-radius: 8px; background: #9146ff; color: #fff; font-weight: bold; }
    button.clear { background: #dc3545; }

    #output { 
      width: 85%; 
      max-width: 500px; 
      padding: 15px; 
      font-family: 'Consolas', monospace; 
      font-size: 14px; 
      border: 2px solid var(--border-color); 
      border-radius: 12px; 
      background: var(--panel-bg); 
      color: var(--text-color);
      text-align: center; 
      cursor: pointer;
    }
    .copied-flash { background-color: #28a745 !important; color: white !important; border-color: #28a745 !important; }
  </style>
</head>
<body>

  <div class="grid-container">
    <div id="grid"></div>
  </div>

  <div class="palette" id="palette"></div>

  <div class="controls">
    <button onclick="clearCanvas()" class="clear">Borrar</button>
    <button onclick="generateCode()">Generar Código</button>
  </div>

  <input type="text" id="output" readonly onclick="copyToClipboard()" placeholder="El código aparecerá aquí">

  <script>
    const colors = ['transparent','#000000','#aa0000','#00aa00','#aa5500','#0000aa','#aa00aa','#00aaaa','#aaaaaa','#555555','#ff5555','#55ff55','#ffff55','#5555ff','#ff55ff','#55ffff','#ffffff'];
    let selectedIdx = 1; 
    let isDrawing = false;

    const grid = document.getElementById('grid');
    const cells = [];

    for (let i = 0; i < 256; i++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      cell.dataset.idx = "0";
      
      cell.addEventListener('mousedown', (e) => { isDrawing = true; paint(cell); e.preventDefault(); });
      cell.addEventListener('mouseover', () => { if(isDrawing) paint(cell); });
      cell.addEventListener('touchstart', (e) => { isDrawing = true; paint(cell); e.preventDefault(); }, {passive: false});

      grid.appendChild(cell);
      cells.push(cell);
    }

    grid.addEventListener('touchmove', (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      const element = document.elementFromPoint(touch.clientX, touch.clientY);
      if (element && element.classList.contains('cell')) paint(element);
    }, {passive: false});

    window.addEventListener('mouseup', () => isDrawing = false);
    window.addEventListener('touchend', () => isDrawing = false);

    function paint(cell) {
      cell.dataset.idx = selectedIdx;
      cell.style.backgroundColor = selectedIdx === 0 ? 'transparent' : colors[selectedIdx];
      cell.style.backgroundImage = selectedIdx === 0 ? '' : 'none';
    }

    const palette = document.getElementById('palette');
    colors.forEach((color, idx) => {
      const swatch = document.createElement('div');
      swatch.className = 'swatch' + (idx === selectedIdx ? ' selected' : '');
      if(color === 'transparent') swatch.classList.add('swatch-transparent');
      else swatch.style.backgroundColor = color;
      
      swatch.onclick = () => {
        document.querySelectorAll('.swatch').forEach(s => s.classList.remove('selected'));
        swatch.classList.add('selected');
        selectedIdx = idx;
      };
      palette.appendChild(swatch);
    });

    function clearCanvas() {
      if(confirm("¿Borrar todo el dibujo?")) {
        cells.forEach(c => { 
          c.dataset.idx = "0"; 
          c.style.backgroundColor = "transparent"; 
          c.style.backgroundImage = '';
        });
        document.getElementById('output').value = "";
      }
    }

    function generateCode() {
      const pixelData = cells.map(c => parseInt(c.dataset.idx));
      const usedColors = [...new Set(pixelData)].sort((a,b) => a-b);
      const buffer = new Uint8Array(128);
      for (let i = 0; i < 256; i += 2) {
        const high = usedColors.indexOf(pixelData[i]);
        const low = usedColors.indexOf(pixelData[i+1]);
        buffer[i/2] = (high << 4) | (low & 0x0F);
      }
      const b64 = btoa(String.fromCharCode(...buffer));
      const header = usedColors.map(c => c.toString(16)).join('');
      document.getElementById('output').value = "!dibujar " + header + "_" + b64;
    }

    async function copyToClipboard() {
      const out = document.getElementById('output');
      if (!out.value || out.value === "¡Copiado!") return;
      try {
        const originalValue = out.value;
        await navigator.clipboard.writeText(originalValue);
        out.value = "¡Copiado!";
        out.classList.add('copied-flash');
        setTimeout(() => {
          out.value = originalValue;
          out.classList.remove('copied-flash');
        }, 1200);
      } catch(err) {}
    }
  </script>
</body>
</html>
