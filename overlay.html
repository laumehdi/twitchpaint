<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Overlay de Dibujos - Fila Continua</title>
  <style>
    body { 
      margin: 0; 
      background: transparent; 
      overflow: hidden; 
      width: 1920px; 
      height: 1080px; 
    }

    /* El contenedor ahora es una tira larga que se mueve */
    #marquee { 
      display: flex; 
      flex-direction: row; 
      align-items: flex-start;
      gap: 50px; /* DISTANCIA ENTRE DIBUJOS: Ajusta esto a tu gusto */
      position: absolute;
      left: 0;
      top: 50px;
      padding-left: 100%; /* Empiezan fuera de la pantalla a la derecha */
      animation: moveContainer 30s linear infinite; /* Animación opcional si quieres que todo se mueva constante */
    }

    /* Estilo de cada dibujo individual */
    .item { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      flex-shrink: 0; /* Importante: evita que los dibujos se aplasten */
    }

    .nick { 
      color: white; 
      font-family: 'Segoe UI', sans-serif; 
      font-weight: bold; 
      text-shadow: 2px 2px 4px #000; 
      margin-bottom: 8px; 
      background: rgba(0,0,0,0.8); 
      padding: 4px 12px; 
      border-radius: 6px;
      font-size: 18px;
    }

    .grid { 
      display: grid; 
      grid-template-columns: repeat(16, 12px); 
      grid-template-rows: repeat(16, 12px); 
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
    }

    .px { width: 12px; height: 12px; }

    /* Animación suave para que la fila avance */
    @keyframes scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-5000px); }
    }
  </style>
</head>
<body>
  <div id="wrapper" style="position: relative; width: 100%; overflow: hidden;">
    <div id="marquee"></div>
  </div>

  <script>
    const CHANNEL = 'laumehdi'; 
    const colors = ['transparent','#000000','#aa0000','#00aa00','#aa5500','#0000aa','#aa00aa','#00aaaa','#aaaaaa','#555555','#ff5555','#55ff55','#ffff55','#5555ff','#ff55ff','#55ffff','#ffffff'];
    
    // Variables para el movimiento manual (más fluido que CSS para esto)
    let currentPosX = window.innerWidth;
    const marquee = document.getElementById('marquee');
    const speed = 2; // VELOCIDAD: Píxeles por frame

    function updateMovement() {
      currentPosX -= speed;
      marquee.style.transform = `translateX(${currentPosX}px)`;
      
      // Si el contenedor ya salió de la pantalla por la izquierda, lo reiniciamos si hay pocos elementos
      // o simplemente dejamos que siga fluyendo.
      requestAnimationFrame(updateMovement);
    }
    updateMovement();

    const ws = new WebSocket('wss://irc-ws.chat.twitch.tv:443');
    ws.onopen = () => {
      ws.send('PASS oauth:none');
      ws.send('NICK justinfan' + Math.floor(Math.random()*10000));
      ws.send(`JOIN #${CHANNEL}`);
    };

    ws.onmessage = (e) => {
      if (e.data.includes('PING')) ws.send('PONG :tmi.twitch.tv');
      const m = e.data.match(/:([^!]+).+PRIVMSG.+(!dibujar\s.+)/);
      if (m) createDrawing(m[1], m[2].split(' ')[1]);
    };

    function createDrawing(user, fullCode) {
      try {
        const [header, b64] = fullCode.split('_');
        const usedColors = header.split('').map(c => parseInt(c, 16));
        const bin = atob(b64);
        
        const container = document.createElement('div');
        container.className = 'item';
        
        const grid = document.createElement('div');
        grid.className = 'grid';

        for (let i = 0; i < bin.length; i++) {
          const byte = bin.charCodeAt(i);
          [byte >> 4, byte & 0x0F].forEach(idxInDict => {
            const px = document.createElement('div');
            px.className = 'px';
            px.style.backgroundColor = colors[usedColors[idxInDict]] || 'transparent';
            grid.appendChild(px);
          });
        }

        container.innerHTML = `<div class="nick">${user}</div>`;
        container.appendChild(grid);
        marquee.appendChild(container);

        // Borrar el dibujo después de un tiempo para no sobrecargar el navegador
        setTimeout(() => container.remove(), 60000); 
      } catch(err) { console.error("Error decodificando"); }
    }
  </script>
</body>
</html>
