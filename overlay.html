<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Overlay de Dibujos - Nombres más grandes</title>
  <style>
    body { 
      margin: 0; 
      background: transparent; 
      overflow: hidden; 
      width: 1920px; 
      height: 1080px; 
    }
    #container { 
      position: relative; 
      width: 100%; 
      height: 100%; 
    }
    .item { 
      position: absolute; 
      top: 20px; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      will-change: transform;
    }
    .nick { 
      color: white; 
      font-family: 'Segoe UI', sans-serif; 
      font-weight: bold; 
      text-shadow: 2px 2px 4px #000; 
      margin-bottom: 6px; 
      background: rgba(0,0,0,0.8); 
      padding: 3px 14px; 
      border-radius: 5px; 
      font-size: 18px; 
      white-space: nowrap;
    }
    .grid { 
      display: grid; 
      grid-template-columns: repeat(16, 12px); 
      grid-template-rows: repeat(16, 12px); 
      background: transparent; 
    }
    .px { width: 12px; height: 12px; }
  </style>
</head>
<body>
  <div id="container"></div>
  <script>
    const CHANNEL = 'laumehdi'; 
    const colors = ['transparent','#000000','#aa0000','#00aa00','#aa5500','#0000aa','#aa00aa','#00aaaa','#aaaaaa','#555555','#ff5555','#55ff55','#ffff55','#5555ff','#ff55ff','#55ffff','#ffffff'];
    
    const speed = 3.5; 
    const spacing = 300; 
    let drawings = [];

    function animate() {
      for (let i = 0; i < drawings.length; i++) {
        const d = drawings[i];
        d.x += speed;
        
        if (d.x > 1920) {
            let minX = 0;
            drawings.forEach(other => { if(other.x < minX) minX = other.x; });
            d.x = minX - spacing; 
        }
        d.el.style.transform = `translateX(${d.x}px)`;
      }
      requestAnimationFrame(animate);
    }
    animate();

    const ws = new WebSocket('wss://irc-ws.chat.twitch.tv:443');
    ws.onopen = () => {
      ws.send('PASS oauth:none');
      ws.send('NICK justinfan' + Math.floor(Math.random()*10000));
      ws.send(`JOIN #${CHANNEL}`);
    };

    ws.onmessage = (e) => {
      if (e.data.includes('PING')) ws.send('PONG :tmi.twitch.tv');
      const parts = e.data.split('PRIVMSG #' + CHANNEL + ' :');
      if (parts.length > 1) {
        const msg = parts[1].trim();
        const user = e.data.split('!')[0].substring(1).toLowerCase();

        if (msg.startsWith('!dibujar ')) {
          createDrawing(user, msg.split(' ')[1]);
        } 
        else if (msg.startsWith('!borrar')) {
          const target = msg.replace('!borrar', '').replace('@', '').trim().toLowerCase();
          if (target === "") {
            removeLastUserDrawing(user);
          } else {
            removeAllUserDrawings(target);
          }
        } 
        else if (msg === '!limpiar') {
          // Lógica de limpieza inteligente
          if (user === CHANNEL.toLowerCase()) {
            // Si eres tú (dueño), limpia TODO
            clearAllDrawings();
          } else {
            // Si es un usuario normal, limpia solo lo SUYO
            removeAllUserDrawings(user);
          }
        }
      }
    };

    function createDrawing(user, fullCode) {
      try {
        const [header, b64] = fullCode.split('_');
        const usedColors = [];
        for(let i=0; i < header.length; i++) {
          if (header[i] === '1' && header[i+1] === '0') { usedColors.push(16); i++; }
          else { usedColors.push(parseInt(header[i], 16)); }
        }

        const bin = atob(b64);
        const itemEl = document.createElement('div');
        itemEl.className = 'item';
        const grid = document.createElement('div');
        grid.className = 'grid';

        for (let i = 0; i < bin.length; i++) {
          const byte = bin.charCodeAt(i);
          [byte >> 4, byte & 0x0F].forEach(idx => {
            const px = document.createElement('div');
            px.className = 'px';
            px.style.backgroundColor = colors[usedColors[idx]] || 'transparent';
            grid.appendChild(px);
          });
        }

        itemEl.innerHTML = `<div class=\"nick\">${user}</div>`;
        itemEl.appendChild(grid);
        document.getElementById('container').appendChild(itemEl);

        let startX = -250; 
        if (drawings.length > 0) {
            let minX = 0;
            drawings.forEach(d => { if(d.x < minX) minX = d.x; });
            startX = minX - spacing;
        }

        drawings.push({ el: itemEl, x: startX, user: user });
      } catch(err) {}
    }

    function removeLastUserDrawing(username) {
      for (let i = drawings.length - 1; i >= 0; i--) {
        if (drawings[i].user === username) {
          drawings[i].el.remove();
          drawings.splice(i, 1);
          break;
        }
      }
    }

    function removeAllUserDrawings(username) {
      drawings = drawings.filter(d => {
        if (d.user === username) { 
          d.el.remove(); 
          return false; 
        }
        return true;
      });
    }

    function clearAllDrawings() {
      drawings.forEach(d => d.el.remove());
      drawings = [];
    }
  </script>
</body>
</html>
